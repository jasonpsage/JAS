{==============================================================================
|    _________ _______  _______  ______  _______  Jegas, LLC                  |
|   /___  ___// _____/ / _____/ / __  / / _____/  JasonPSage@jegas.com        |
|      / /   / /__    / / ___  / /_/ / / /____                                |
|     / /   / ____/  / / /  / / __  / /____  /                                |
|____/ /   / /___   / /__/ / / / / / _____/ /                                 |
/_____/   /______/ /______/ /_/ /_/ /______/                                  |
|                 Under the Hood                                              |
===============================================================================
                       Copyright(c)2012 Jegas, LLC
==============================================================================}


//=============================================================================
{}
// Purpose : Provide low level web Browser like functionlaity
//
// This unit utilizes the Synapse Network Protocall library to allow making
// web requests like a web browser would and returns the results so that
// processing can be performed as desired.
Unit ug_browser;
//=============================================================================

//=============================================================================
// Global Directives
//=============================================================================
{$INCLUDE i_jegas_macros.pp}
{$DEFINE SOURCEFILE:='ug_browser.pp'}
{$SMARTLINK ON}
{$PACKRECORDS 4}
{$MODE objfpc}
//=============================================================================





//*****************************************************************************
//=============================================================================
//*****************************************************************************
//
                               Interface
//             
//*****************************************************************************
//=============================================================================
//*****************************************************************************


//=============================================================================
Uses 
//=============================================================================
classes
,dos
{$IFDEF linux}
,baseunix
{$ENDIF}
,sysutils
,httpsend
,ug_misc
,ug_common
;
//=============================================================================


//*****************************************************************************
//=============================================================================
//*****************************************************************************
// !@!Declarations 
//*****************************************************************************
//=============================================================================
//*****************************************************************************

//=============================================================================
{}
function saHTTP_Send(
  p_saHost: ansistring;
  p_saFile: ansistring; 
  p_bPost: boolean; 
  p_saPostData: ansistring; 
  var p_iResultcode: longint
): ansistring;
//=============================================================================







//*****************************************************************************
//=============================================================================
//*****************************************************************************
//
                              Implementation
//            
//*****************************************************************************
//=============================================================================
//*****************************************************************************

//=============================================================================
function saHTTP_Send(
  p_saHost: ansistring; 
  p_saFile: ansistring; 
  p_bPost: boolean; 
  p_saPostData: ansistring; 
  var p_iResultcode: longint
): ansistring;
//=============================================================================
var 
  HTTP: THTTPSend;
  saOut: ansistring;
  saDataIn: ansistring;
  saMethod: ansistring;
  bOk: boolean;
begin
  HTTP:=THTTPSend.create;
  //HTTP.Headers.Add('Jegas: JAS-CGI 1.0.0');
  HTTP.Headers.Add('User-Agent: Jegas/1.0 (Browser Class - uxxg_browser)');
  HTTP.Headers.Add('Cache-Control: max-age=0');
  if not p_bPost then
  begin
    saOut:='';
    saMethod:='GET '+p_saFile;
  end
  else
  begin
    Http.MimeType:='application/x-www-form-urlencoded';
    saOut+=p_saPostData;
    saMethod:='POST '+p_saFile;
  end;
  HTTP.Document.Write(PCHAR(saOut)^,length(saOut));

  try
    bOk:=HTTP.HTTPMethod(saMethod, p_saHost);
    if bOk then
    begin
      //write(Http.headers.text);
      //write(csINET_HDR_CONTENT_TYPE+csMIME_TextHtml +csCRLF);
      //write('Content-length: ' + saStr(Http.Document.Size) + csCRLF+csCRLF);
      setlength(saDataIn,Http.Document.Size);
      Http.Document.ReadBuffer(PCHAR(saDataIn)^, Http.Document.Size);
    end;
  finally
  end;//try    

  p_iResultcode:=Http.Resultcode;
  result:=saDataIn;
  HTTP.free;
end;
//=============================================================================






//=============================================================================
// Initialization
//=============================================================================
Begin
//=============================================================================
//=============================================================================
End.
//=============================================================================


//*****************************************************************************
// eof
//*****************************************************************************
